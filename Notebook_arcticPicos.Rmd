---
title: "Arctic picos"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r packages}
library(iNEXT)
library(tidyverse)
library(tidyr) 
library(dplyr)
library(ggplot2)
library(vegan)
library(tibble) #for "rownames_to_column('Site')" 
library(geodist)
library(reshape2)
library(UpSetR)
library(ComplexHeatmap)#if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager") BiocManager::install("ComplexHeatmap")
```

```{r import_data, echo=TRUE, warning=FALSE}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/import.R", encoding = "UTF-8")

```

#remove outliers
```{r}
outliers <- c("HE533.Euk.F02.04C_S9", "HE533.Euk.F02.08B_S20", "HE533.Euk.F02.08C_S21", "HE533.Euk.F02.09A_S22",
              "HE533.Euk.F02.10A_S25", "HE533.Euk.F02.10C_S27", "HE533.Euk.F02.11A_S28", "HE533.Euk.F02.11C_S30",
              "HE533.Euk.F02.12B_S32", "HE533.Euk.F02.12C_S33", "HE533.Euk.F02.19C_S54", "HE533.Euk.F02.22C_S63")

#outliers_prok <- c("HE533.Prok.F02.4C_S11", "HE533.Prok.F02.8B_S26" ,"HE533.Prok.F02.8C_S27", #"HE533.Prok.F02.9A_S29",
#                   "HE533.Prok.F02.10A_S33", "HE533.Prok.F02.11A_S37", "HE533.Prok.F02.11C_S39",
#                   "HE533.Prok.F02.12B_S42", "HE533.Prok.F02.12C_S43", "HE533.Prok.F02.19C_S71",
#                   "HE533.Prok.F02.22C_S83")

#remove replicates

rep_18S <- c("HE533.Euk.F02.25B_S68", "HE533.Euk.F02.25C_S69", "HE533.Euk.F02.26B_S71", "HE533.Euk.F02.26C_S72",
         "HE533.Euk.F02.27B_S74", "HE533.Euk.F02.27C_S75", "HE533.Euk.F02.28B_S77", "HE533.Euk.F02.28C_S78",
         "HE533.Euk.F02.21B_S59", "HE533.Euk.F02.21C_S60", "HE533.Euk.F02.22B_S62", "HE533.Euk.F02.23B_S65",
         "HE533.Euk.F02.23C_S66", "HE533.Euk.F02.17B_S47", "HE533.Euk.F02.17C_S48", "HE533.Euk.F02.18B_S50",
         "HE533.Euk.F02.18C_S51", "HE533.Euk.F02.19B_S53", "HE533.Euk.F02.20B_S56", "HE533.Euk.F02.20C_S57",
         "HE533.Euk.F02.13C_S36", "HE533.Euk.F02.14B_S38", "HE533.Euk.F02.14C_S39", "HE533.Euk.F02.15B_S41",
         "HE533.Euk.F02.15C_S42", "HE533.Euk.F02.16B_S44", "HE533.Euk.F02.16C_S45", "HE533.Euk.F02.07B_S17",
         "HE533.Euk.F02.07C_S18", "HE533.Euk.F02.09C_S24", "HE533.Euk.F02.04B_S8", "HE533.Euk.F02.05B_S11",
         "HE533.Euk.F02.05C_S12", "HE533.Euk.F02.06B_S14", "HE533.Euk.F02.06C_S15", "HE533.Euk.F02.2B_S2",
         "HE533.Euk.F02.2C_S3", "HE533.Euk.F02.3B_S5", "HE533.Euk.F02.3C_S6")

rep_16S <- c("HE533.Prok.F02.25B_S90",  "HE533.Prok.F02.25C_S91", "HE533.Prok.F02.26B_S94", "HE533.Prok.F02.26C_S95", "HE533.Prok.F02.27B_S98", "HE533.Prok.F02.27C_S99", "HE533.Prok.F02.28B_S102", "HE533.Prok.F02.28C_S103", "HE533.Prok.F02.21B_S78",  "HE533.Prok.F02.21C_S79", "HE533.Prok.F02.22B_S82",  "HE533.Prok.F02.22C_S83", "HE533.Prok.F02.23B_S86", "HE533.Prok.F02.23C_S87", "HE533.Prok.F02.17B_S62", "HE533.Prok.F02.17C_S63", "HE533.Prok.F02.18B_S66",  "HE533.Prok.F02.18C_S67", "HE533.Prok.F02.19B_S70",  "HE533.Prok.F02.19C_S71", "HE533.Prok.F02.20B_S74", "HE533.Prok.F02.20C_S75", "HE533.Prok.F02.11B_S38",  "HE533.Prok.F02.11C_S39", "HE533.Prok.F02.12B_S42",  "HE533.Prok.F02.12C_S43", "HE533.Prok.F02.13B_S46", "HE533.Prok.F02.13C_S47", "HE533.Prok.F02.14B_S50", "HE533.Prok.F02.14C_S51", "HE533.Prok.F02.15B_S54",  "HE533.Prok.F02.15C_S55", "HE533.Prok.F02.16B_S58",  "HE533.Prok.F02.16C_S59", "HE533.Prok.F02.10B_S22",  "HE533.Prok.F02.7B_S34",  "HE533.Prok.F02.7C_S23", "HE533.Prok.F02.8B_S26",   "HE533.Prok.F02.8C_S27", "HE533.Prok.F02.2B_S2", "HE533.Prok.F02.2C_S3", "HE533.Prok.F02.3B_S6", "HE533.Prok.F02.3C_S7",
             "HE533.Prok.F02.4B_S10", "HE533.Prok.F02.4C_S11", "HE533.Prok.F02.5B_S14", "HE533.Prok.F02.5C_S15", "HE533.Prok.F02.6B_S18", "HE533.Prok.F02.6C_S19")

###remove outliers for better visualization

euk_r <- eukaryotes%>%dplyr::select(!outliers)
euk_r <- euk_r%>%dplyr::select(!rep_18S)
euk_r <- euk_r[rowSums(euk_r)>0,]

prok_r <- prokaryotes%>%dplyr::select(!rep_16S)
prok_r <- prok_r[rowSums(prok_r)>0,]
prokaryotes = prok_r

meta_18S_r <- meta_18S%>%dplyr::filter(Site %in% colnames(euk_r))
meta_16S <- meta_16S%>%dplyr::filter(Site %in% colnames(prokaryotes))
rm(outliers, rep_16S, rep_18S)
```

#map
```{r}

source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/map.R", encoding = "UTF-8")

```

# metadata removing NAs and z-scoring 
```{r z_score}
##prokaryotes

#replace below detection with actual number
meta_16S$PO4..µmol.l. <- gsub("<LOQ","0.001", meta_16S$PO4..µmol.l.)
meta_16S$Si..µmol.l. <- gsub("<LOQ","0.001", meta_16S$Si..µmol.l.)

meta_16S$PO4..µmol.l. <- as.numeric(meta_16S$PO4..µmol.l.)
meta_16S$Si..µmol.l. <- as.numeric(meta_16S$Si..µmol.l.)


#remove NAs and reduce to relevant metadata

metadata_16S <- c("Site", "Station", "Region", "Fjord","In.Out", "Sill", "Latitude", "Longitude", "Date", "Time",
                  "temperature...C.", "salinity..psu.","O.conc..µmol.l.", "Fluorometer",
                  "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.",
                  "Glacial.influence", "Current_flow", "Current_score")

meta_16S_nNA <-meta_16S[metadata_16S]%>% 
  mutate_all(~ifelse(. %in% c("N/A", "null", ""), NA, .)) %>% 
  na.omit()


##eukaryotes

#replace below detection with actual number
meta_18S_r$PO4..µmol.l. <- gsub("<LOQ","0.001", meta_18S_r$PO4..µmol.l.)
meta_18S_r$Si..µmol.l. <- gsub("<LOQ","0.001", meta_18S_r$Si..µmol.l.)

meta_18S_r$PO4..µmol.l. <- as.numeric(meta_18S_r$PO4..µmol.l.)
meta_18S_r$Si..µmol.l. <- as.numeric(meta_18S_r$Si..µmol.l.)


#remove NAs and reduce to relevant metadata

metadata_18S <- c("Site","Station", "Region", "Fjord","In.Out", "Sill", "Latitude", "Longitude", "Date", "Time",
                  "Temperature...C.", "Salinity..psu.","O.conc..µmol.l.", "Fluorometer",
                  "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.",
                  "Glacial.influence", "Current_flow", "Current_score")

meta_18S_nNA <-meta_18S_r[metadata_18S]%>% 
  mutate_all(~ifelse(. %in% c("N/A", "null", ""), NA, .)) %>% 
  na.omit()


```
# metadata exploration (note: the code for the meta_all is further down until now)
```{r meta, echo=TRUE}


source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/MLD_DK.R", encoding = "UTF-8")
eval(parse("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/MLD_calculations.R", encoding = "UTF-8"))

meta_all <- dplyr::inner_join(meta_16S_m, meta_18S_nNA[1:2], by="Station")
meta_all$In.Out <- as.factor(meta_all$In.Out)

list_meta <- sapply(ls(pattern="meta_"), function(x) get(x), simplify = FALSE)
rm(list = ls(pattern="meta_"))

```


```{r}
eval(parse("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/env_data.R", encoding = "UTF-8"))
```



```{r alpha_div, echo=TRUE, fig.width=7,fig.height=3.5, fig.show="hold", out.width="50%"}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/alpha_diversity.R")

#the following is very intense comuting so better to not run it too often
euk_r_alpha <- diversity_iNEXT(euk_r)
prok_alpha <- diversity_iNEXT(prokaryotes)


euk_r_alpha_meta <- left_join(euk_r_alpha, list_meta$meta_18S_r, by = "Site")
prok_alpha_meta <- left_join(prok_alpha, list_meta$meta_16S, by = "Site")

euk_r_alpha_n <- euk_r_alpha_meta%>%
  dplyr::rename(Richness.euk = Richness)%>%
  dplyr::rename(Shannon.euk = Shannon)%>%
  dplyr::rename(Simpson.euk = Simpson)

prok_alpha_n <- prok_alpha_meta%>%
  dplyr::rename(Richness.prok = Richness)%>%
  dplyr::rename(Shannon.prok = Shannon)%>%
  dplyr::rename(Simpson.prok = Simpson)


euk_r_alpha_meta_l <- euk_r_alpha_n%>%gather(Div_indices, Div_value, Richness.euk, Shannon.euk, Simpson.euk)
prok_alpha_meta_l <- prok_alpha_n%>%gather(Div_indices, Div_value, Richness.prok, Shannon.prok, Simpson.prok)
div_sub <- c("Station", "Glacial.influence","In.Out", "Div_indices", "Div_value")

div_alpha_both <- full_join(euk_r_alpha_meta_l[,div_sub], prok_alpha_meta_l[,div_sub])

list_div <- sapply(ls(pattern="_alpha"), function(x) get(x), simplify = FALSE)
rm(list = ls(pattern="_alpha"))

```

```{r}
#z-scoring

metadata_16S.z <- c("Site", "Station", "Region", "Fjord","In.Out", "Latitude", "Longitude", "Date", "Time",
                  "temperature...C.", "salinity..psu.","O.conc..µmol.l.", "Fluorometer",
                  "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.",
                  "Glacial.influence", "MLD", "bottom_depth", "Current_flow", "Current_score")

z_score_16S <- c("temperature...C.", "salinity..psu.","O.conc..µmol.l.", "Fluorometer",
            "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "MLD", "bottom_depth")


meta_16S_nNA.z <- list_meta$meta_16S_m

meta_16S_nNA.z <-meta_16S_nNA.z[metadata_16S.z]%>% 
  mutate_all(~ifelse(. %in% c("N/A", "null", ""), NA, .)) %>% 
  na.omit()


meta_16S_nNA.z[z_score_16S] <- lapply(meta_16S_nNA.z[z_score_16S], function(x) {y <-scale(x, center = TRUE, scale = TRUE)})

#z-scoring

z_score_18S <- c("Temperature...C.", "Salinity..psu.","O.conc..µmol.l.", "Fluorometer",
            "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "MLD", "bottom_depth")

metadata_18S.z <- c("Site","Station", "Region", "Fjord","In.Out", "Latitude", "Longitude", "Date", "Time",
                  "Temperature...C.", "Salinity..psu.","O.conc..µmol.l.", "Fluorometer",
                  "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.",
                  "Glacial.influence", "MLD", "bottom_depth", "Current_flow", "Current_score")

meta_18S_nNA.z <- list_meta$meta_18S_m

meta_18S_nNA.z <-meta_18S_nNA.z[metadata_18S.z]%>% 
  mutate_all(~ifelse(. %in% c("N/A", "null", ""), NA, .)) %>% 
  na.omit()



meta_18S_nNA.z[z_score_18S] <- lapply(meta_18S_nNA.z[z_score_18S], function(x) {y <-scale(x, center = TRUE, scale = TRUE)})


meta_all.z <- list_meta$meta_all

meta_all.z[z_score_16S] <- lapply(meta_all.z[z_score_16S], function(x) {y <-scale(x, center = TRUE, scale = TRUE)})

```


##cluster analysis metadata

```{r}
require(dendextend)

meta_all.z <- meta_all.z %>%
  mutate(Region_color = case_when(
    Region == "Iceland" ~ "#A64995", 
    Region == "East.Greenland" ~ "#BDD014",
    Region == "West.Greenland" ~ "#442D87", 
    Region == "North.Norway" ~ "#2B62FC",
    Region == "South.Norway" ~ "#A331A0", 
    Region == "Svalbard" ~ "#720E34"
    ))

meta_all.z <- meta_all.z %>%
  mutate(Glacier_color = case_when(
    Glacial.influence == "No" ~ "seagreen", 
    Glacial.influence == "Yes" ~ "orange2",
    ))


dist_meta<- c("temperature...C.", "salinity..psu.", "Fluorometer",
                   "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "MLD", "bottom_depth")

dist_mat <- vegan::vegdist(meta_all.z[dist_meta], method = 'euclidean')
dend <- hclust(dist_mat, method = 'average') %>% as.dendrogram

labels(dend) <- meta_all.z$Fjord
labels_colors(dend) <- meta_all.z$Glacier_color

plot(dend)
```



alpha diversity boxplots
```{r div_boxplots}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/boxplot_alphadiv.R")
```

## data transformations
```{r transformations}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/transformation_CLR_aitchinson.R")

euk_aitchinson <- dczm(euk_r, 1)
prok_aitchinson <- dczm(prokaryotes, 5)
#prok_aitchinson_r <- dczm(prok_r, 5)


euk_clr <- clr(euk_r,1)
prok_clr <- clr(prokaryotes, 5)

taxonomy_16S_clr <- taxonomy_16S%>%filter(rownames %in% rownames(prok_clr))
taxonomy_16S_clr$ASV <- taxonomy_16S_clr$rownames

```



```{r nmds, fig.width=5,fig.height=5, fig.show="hold", out.width="50%"}
#source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/NMDS.R")

#nmds_plot(prok_aitchinson, meta_16S)
#nmds_plot(euk_aitchinson, meta_18S)

```
*subsample those fjords where comparison between tip mouth / glacier influence is doable*

```{r}
euk_ait_df <- as.data.frame(as.matrix(euk_aitchinson))
prok_ait_df <- as.data.frame(as.matrix(prok_aitchinson))
#prok_ait_r_df <- as.data.frame(as.matrix(prok_aitchinson_r))
```

#NMDS of tip/moth of fjords
```{r}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/NMDS_fjords.R")

#nmds_fjords(asv_tip_mouth_prok_a_ait_df, meta_tip_mouth_16S)
#nmds_fjords(asv_tip_mouth_euk, meta_tip_mouth_18S)

source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/NMDS_fjords_eukr.R")


#nmds_fjords_r(euk_ait_df, meta_18S_r)
#nmds_fjords_r(prok_ait_df, meta_16S)
```


RDA
```{r}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/RDA_plots.R")
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/RDA_ordistep.R")

## prokaryotes

RDA_input_16S <- c("Site","temperature...C.", "salinity..psu.", "Fluorometer",
                   "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "MLD", "bottom_depth")

prok_nNA <- prokaryotes%>%dplyr::select(meta_16S_nNA.z$Site)
prok_clr_nNA <- prok_clr%>%dplyr::select(meta_16S_nNA.z$Site)
prok_ait_nNA <- prok_ait_df%>%dplyr::select(meta_16S_nNA.z$Site)
prok_ait_nNA <- prok_ait_nNA%>%dplyr::filter(rownames(prok_ait_nNA) %in% colnames(prok_ait_nNA))


ait_dist_16S <- dczm(prok_nNA, 5)
ordi(prok_clr_nNA, meta_16S_nNA.z[RDA_input_16S])

#ordistep function removes Si

#RDA plot

meta_sig <- c("temperature...C.", "salinity..psu.", "Fluorometer",
                   "PO4..µmol.l.", "NO3..µmol.l.", "bottom_depth")

RDA_plots(meta_16S_nNA.z, prok_clr_nNA, prok_ait_nNA)

## eukaryotes

RDA_input_18S <- c("Site","Temperature...C.", "Salinity..psu.", "Fluorometer",
                   "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "MLD", "bottom_depth")



euk_clr_nNA <- euk_clr%>%dplyr::select(meta_18S_nNA.z$Site)
euk_ait_nNA <- euk_ait_df%>%dplyr::select(meta_18S_nNA.z$Site)
euk_nNA <- eukaryotes%>%dplyr::select(meta_18S_nNA.z$Site)

ait_dist_18S <- dczm(euk_nNA, 1)

ordi(euk_clr_nNA, meta_18S_nNA.z[RDA_input_18S])

#ordistep function confirms that all variables contribute significantly

meta_sig <- c("Temperature...C.", "Salinity..psu.", "Fluorometer",
                   "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "bottom_depth")

#RDA plot

RDA_plots(meta_18S_nNA.z, euk_clr_nNA, euk_ait_nNA)

```

#distance analysis

```{r}
require(metagMisc)
require(kmed)
ait_dist_vector <- dist2list(ait_dist_16S, tri = TRUE)
ait_dist_vector$col <- ait_dist_vector$col
ait_dist_vector$row <- ait_dist_vector$row

list_meta$meta_16S_nNA$In.Out <- as.factor(list_meta$meta_16S_nNA$In.Out)
current <- list_meta$meta_16S_nNA%>%dplyr::select(Site, Current_score) #, In.Out)
rownames(current) <- current$Site
current$Site <- NULL
current$Current_score <- as.numeric(current$Current_score)

env_dist_current <- vegan::vegdist(current, method = "jaccard")
env_dist_current_df <- dist2list(env_dist_current, tri = TRUE)#jaccard because it's rank-based


#env_dist_current <- kmed::distmix(current, method = "gower", idnum = 1, idbin = NULL, idcat = NULL)
#env_dist_current_d <- as.dist(env_dist_current)
#env_dist_current_df <- dist2list(env_dist_current_d, tri = TRUE)


env_dist_current_df$col <- as.character(env_dist_current_df$col)
env_dist_current_df$row <- as.character(env_dist_current_df$row)

all_16S <- inner_join(ait_dist_vector, env_dist_current_df, by = c('col', 'row'))

all_16S$lev <- gsub("_.*", "", all_16S$col)
all_16S$lev <- gsub(".Prok.*", "", all_16S$lev)
all_16S$lev.2 <- gsub("_.*", "", all_16S$row)
all_16S$lev.2 <- gsub(".Prok.*", "", all_16S$lev.2)
all_16S <-unite(all_16S, var_TT, c(lev, lev.2), remove=FALSE)

all_16S$Site <- all_16S$col
all_16S_t <- dplyr::left_join(all_16S, list_meta$meta_16S_nNA[,1:5], by = "Site")

all_16S_t$Site <- NULL

all_16S_t$Site <- all_16S_t$row
all_16S_t <- dplyr::left_join(all_16S_t, list_meta$meta_16S_nNA[,1:5], by = "Site")

all_16S_t$Site <- NULL
all_16S_t <-unite(all_16S_t, region_TT, c(Region.x, Region.y), remove=FALSE)
all_16S_t <-unite(all_16S_t, fjord_pos_TT, c(In.Out.x, In.Out.y), remove=FALSE)

 a <- ggplot(all_16S_t, aes(y=value.x, x=value.y), color = "black")+
  geom_point(shape=1, size=1) + 
  #geom_smooth(aes(y=value.x, x=value.y), method='lm') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="none")+
  ylab("Aitchinson distance 16S") + 
  xlab("oceanographic distance based on current flow") + 
  ggtitle("current influence on ASV distance")
 
print(a)

#a <- ggplot(all_16S, aes(y=value.x, x=value.y))+
#  geom_hex()
 
##mantel test
 
vegan::mantel(env_dist_current, ait_dist_16S, method="pearson", permutations=999, strata = NULL, na.rm = FALSE, parallel = 1)

 #eukaryotes
 
ait_dist_list_euk <- dist2list(ait_dist_18S, tri = TRUE)

current_euk <- list_meta$meta_18S_nNA%>%dplyr::select(Site, Current_score)
rownames(current_euk) <- current_euk$Site
current_euk$Site <- NULL
env_dist_current_euk <- vegan::vegdist(current_euk, method = "jaccard", na.rm = FALSE)
env_dist_current_l_euk<- dist2list(env_dist_current_euk, tri = TRUE)

all_18S <- inner_join(ait_dist_list_euk, env_dist_current_l_euk, by = c('col', 'row'))

all_18S$lev <- gsub("_.*", "", all_18S$col)
all_18S$lev <- gsub(".Euk.*", "", all_18S$lev)
all_18S$lev <- gsub("X.*", "MSM56", all_18S$lev)
all_18S$lev.2 <- gsub("_.*", "", all_18S$row)
all_18S$lev.2 <- gsub(".Euk.*", "", all_18S$lev.2)
all_18S$lev.2 <- gsub("X.*", "MSM56", all_18S$lev.2)
all_18S <-unite(all_18S, var_TT, c(lev, lev.2), remove=FALSE)

all_18S$Site <- all_18S$col
all_18S_t <- dplyr::left_join(all_18S, list_meta$meta_18S_nNA[,1:5], by = "Site")

all_18S_t$Site <- NULL

all_18S_t$Site <- all_18S_t$row
all_18S_t <- dplyr::left_join(all_18S_t, list_meta$meta_18S_nNA[,1:5], by = "Site")

all_18S_t$Site <- NULL
all_18S_t <-unite(all_18S_t, region_TT, c(Region.x, Region.y), remove=FALSE)
all_18S_t <-unite(all_18S_t, fjord_pos_TT, c(In.Out.x, In.Out.y), remove=FALSE)

b <- ggplot(all_18S_t, aes(y=value.x, x=value.y),colour = "black")+
  geom_point(shape=1, size=1) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="none")+
  ylab("Aitchinson distance 18S") + 
  xlab("oceanographic distance based on current flow") + 
  ggtitle("current influence on ASV distance")
 
 print(b)
 
 
vegan::mantel(env_dist_current_euk, ait_dist_18S, method="pearson", permutations=999, strata = NULL, na.rm = FALSE, parallel = 1)

```

load("~/Studenten/arctic_picos/Submission/20210719_Rdata.RData")

gdm glacier and non-glacier

```{r}
#using RDA_inputs + lat/long

#source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/gdm.R")

#gdm_input_16S <- c("Site","Latitude", "Longitude","temperature...C.",
#                   "salinity..psu.","Current_flow")

#gdm_input_18S <- c("Site","Latitude", "Longitude","Temperature...C.",
#                   "Salinity..psu.","O.conc..µmol.l.", "Fluorometer",
#                   "PO4..µmol.l.", "Si..µmol.l.", "NO3..µmol.l.", "NH4..µmol.l..")

#gdm_analysis(prok_ait_nNA, list_meta$meta_16S_m[gdm_input_16S])

```


# Indicator species

https://jkzorz.github.io/2019/07/02/Indicator-species-analysis.html


```{r}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/indicator_species.R")

#indicator(prok_hellinger, meta_16S$Glacial.influence, taxonomy_16S)

tax_18S_clr_nNA <- taxonomy_18S%>%dplyr::filter(ASV %in% rownames(euk_clr_nNA))

indicator(euk_clr, list_meta$meta_18S_r$Glacial.influence, tax_18S_clr_nNA)


indicator_euks <- Indicator_summary_t%>%dplyr::filter(p.value <= 0.001)
indicator_euks_GLACIER <- indicator_euks%>%dplyr::filter(index == 2)
indicator_euks_NO_GLACIER <- indicator_euks%>%dplyr::filter(index == 1)

#sort the indicators according to stats
indicator_euks_GLACIER <- with(indicator_euks_GLACIER, indicator_euks_GLACIER[order(-indicator_euks_GLACIER$stat),])
indicator_euks_NO_GLACIER <- with(indicator_euks_NO_GLACIER, indicator_euks_NO_GLACIER[order(-indicator_euks_NO_GLACIER$stat),])

indicator_10_euks_glacier <- indicator_euks_GLACIER[c(1:10),]
indicator_10_euks_NOglacier <- indicator_euks_NO_GLACIER[c(1:10),]

#####
indicator(prok_clr_nNA, list_meta$meta_16S_nNA$Glacial.influence, taxonomy_16S_clr)

indicator_prok <- Indicator_summary_t%>%dplyr::filter(p.value <= 0.001)
indicator_prok_GLACIER <- indicator_prok%>%dplyr::filter(index == 2)
indicator_prok_NO_GLACIER <- indicator_prok%>%dplyr::filter(index == 1)

#sort the indicators according to stats
indicator_prok_GLACIER <- with(indicator_prok_GLACIER, indicator_prok_GLACIER[order(-indicator_prok_GLACIER$stat),])
indicator_prok_NO_GLACIER <- with(indicator_prok_NO_GLACIER, indicator_prok_NO_GLACIER[order(-indicator_prok_NO_GLACIER$stat),])



```

#results (approx.)

glacier euk communities Syndiniales + micromonas

non-glacier: fungi (Opisthokonta),	Phaeocystis

1) boxplot of the different species
2) merge the large groups (if they fit) into one abundance
3) network analyses- what are the central nodes in the two groups? 
4) use this abundance for correlation analyses with bacteria

#Network analyses

https://doi.org/10.1093/bib/bbaa290

```{r}
#concatenate the ASV tables after clr transformation

meta_all <- dplyr::inner_join(list_meta$meta_16S, list_meta$meta_18S_r[1:2], by="Station")

Prok_r_clr <- prok_clr%>%dplyr::select(meta_all$Site.x)
#rename the columns

Prok_r_clr_rename <- Prok_r_clr%>%rename_at(vars(meta_all$Site.x), ~ meta_all$Station)

Euk_r_clr <- euk_clr%>%dplyr::select(meta_all$Site.y)

Euk_r_clr_rename <- Euk_r_clr%>%rename_at(vars(meta_all$Site.y), ~ meta_all$Station)

#concatenate based on the same column names

merged_clr_all <- rbind(Prok_r_clr_rename, Euk_r_clr_rename)

#taxonomy

t_16S <- c("kingdom", "phylum", "class", "genus", "family", "species")
t_18S <- c("kingdom", "supergroup", "phylum", "class", "order", "family")
trans <- c("Tax_1", "Tax_2", "Tax_3", "Tax_4", "Tax_5", "Tax_6")

df <- data.frame(trans, t_16S, t_18S)

taxonomy_16S_r <- taxonomy_16S%>%dplyr::select(df$t_16S)
taxonomy_16S_r_rename <- taxonomy_16S_r%>%rename_at(vars(df$t_16S), ~ df$trans)

taxonomy_18S_r <- taxonomy_18S%>%dplyr::select(df$t_18S)
taxonomy_18S_r_rename <- taxonomy_18S_r%>%rename_at(vars(df$t_18S), ~ df$trans)

taxonomy_merged <- rbind(taxonomy_16S_r_rename, taxonomy_18S_r_rename)
taxonomy_merged_clr <- taxonomy_merged%>%dplyr::filter(rownames(taxonomy_merged) %in% rownames(merged_clr_all))

#replace "uncultured" with empty field

taxonomy_merged_clr$Tax_6 <- gsub("uncultured","",taxonomy_merged_clr$Tax_6)
taxonomy_merged_clr$Tax_5 <- gsub("uncultured","",taxonomy_merged_clr$Tax_5)
taxonomy_merged_clr$Tax_4 <- gsub("uncultured","",taxonomy_merged_clr$Tax_4)


taxonomy_merged_clr[taxonomy_merged_clr==" "]<-NA
taxonomy_merged_clr[taxonomy_merged_clr==""]<-NA

taxonomy_merged_clr$Tax_6[is.na(taxonomy_merged_clr$Tax_6)] <- "f__"
taxonomy_merged_clr$Tax_5[is.na(taxonomy_merged_clr$Tax_5)] <- "g__"
```


#heatmap with indicators
```{r}
#source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/correlation_Indicators.R")

#dendro_heat(cor_glacier_genus)
#dendro_heat(cor_NOglacier_genus)
```


network analysis with both 16S and 18S
```{r}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/network_netCoMi_all.R")

```



```{r}
source("C:/Users/choerstm/Documents/Studenten/arctic_picos/Submission/network_individual.R")

#only eukaryotes
  
  OTU = otu_table(Euk_r_clr_rename, taxa_are_rows = TRUE)
  
  tax.matrix<- as.matrix(taxonomy_18S_r_rename)
  TAX = tax_table(tax.matrix)
  rownames(meta_all) <- meta_all$Station
  map = sample_data(meta_all)
  
  phyloseq_merged = phyloseq(OTU, TAX)
  all_e = merge_phyloseq(phyloseq_merged, map) ####merge data into phyloseq
  all_e

  network_netCoMi(all_e)  
  #only prokaryotes
  
  OTU = otu_table(Prok_r_clr_rename, taxa_are_rows = TRUE)
  
  tax.matrix<- as.matrix(taxonomy_16S_r_rename)
  TAX = tax_table(tax.matrix)
  rownames(meta_all) <- meta_all$Station
  map = sample_data(meta_all)
  
  phyloseq_merged = phyloseq(OTU, TAX)
  all_p = merge_phyloseq(phyloseq_merged, map) ####merge data into phyloseq
  all_p
  
network_netCoMi(all_p)
```

bar with ASVs from network

```{r}


  
```

